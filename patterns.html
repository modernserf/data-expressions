<!doctype html><html ><head ><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1"><title >patterns.js | DatEx</title><link rel="stylesheet" type="text/css" href="doc.css" /></head><body ><aside class="comment"><h1 id="patterns">Patterns</h1>
<p> Just as regex are composed from patterns that match strings, datex are composed from patterns that match data structures. Some of these patterns match the data directly, while others -- much like the <code>|</code>, <code>+</code> and <code>*</code> in regular expressions, are used to combine these patterns.</p>
<p> Datex are implemented as ES6 generators. A <strong>pattern</strong>, when called with a <strong>focus</strong>, will <strong>yield</strong> an object with the shape <code>{ match, replace }</code> for every match. If the generator yields no results, the match has <strong>failed</strong>; otherwise it has <strong>succeeded</strong>.</p>
<h2 id="basic-patterns">Basic Patterns</h2>
<h3 id="-where-fn-"><code>${where(fn)}</code></h3>
</aside><details class="content"><summary ><code ><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">where</span> <span class="token operator">=</span> <span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">function</span> <span class="token operator">*</span> <span class="token punctuation">(</span>focus<span class="token punctuation">)</span> <span class="token punctuation">{</span></code></summary><code >  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fn</span><span class="token punctuation">(</span>focus<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><code >    <span class="token keyword">yield</span> <span class="token punctuation">{</span> match<span class="token punctuation">:</span> focus<span class="token punctuation">,</span> replace<span class="token punctuation">:</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=></span> value <span class="token punctuation">}</span></code><code >  <span class="token punctuation">}</span></code><code ><span class="token punctuation">}</span></code></details><aside class="comment"><p> <code>.test</code> succeeds if the function returns true, and fails if it returns false.</p>
</aside><section class="test" id="test_export function test_where,where"><code class="expect">dx<span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">=></span> x <span class="token operator">></span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">true</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">=></span> x <span class="token operator">></span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">false</span></code></section><aside class="comment"><p> <code>.match</code> yields the focus if the function returns true, and nothing if it returns false.</p>
</aside><section class="test" id="test_export function test_where_match,where_match"><code class="expect"><span class="token punctuation">[</span><span class="token operator">...</span>dx<span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">=></span> x <span class="token operator">></span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">.</span><span class="token function">matchAll</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code><code class="to-equal"><span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span></code><code class="expect"><span class="token punctuation">[</span><span class="token operator">...</span>dx<span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">=></span> x <span class="token operator">></span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">.</span><span class="token function">matchAll</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code><code class="to-equal"><span class="token punctuation">[</span><span class="token punctuation">]</span></code></section><aside class="comment"><p> <code>.replace</code> returns the replacement value if the function returns true, and the focus if it returns false.</p>
</aside><section class="test" id="test_export function test_where_replace,where_replace"><code class="expect">dx<span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">=></span> x <span class="token operator">></span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token number">500</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">=></span> x <span class="token operator">></span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token number">1</span></code></section><aside class="comment"><h3 id="-id-_"><code>${id}</code>, <code>_</code></h3>
<p> Always succeeds. Useful as a placeholder in complex expressions.</p>
</aside><div class="content"><code ><span class="token keyword">export</span> <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token boolean">true</span><span class="token punctuation">)</span></code></div><aside class="comment"><p> <code>.match</code> will always return the focus; <code>.replace</code> will always return the replacement value.</p>
</aside><section class="test" id="test_export function test_id,id"><code class="expect">dx<span class="token template-string"><span class="token string">`_`</span></span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`_`</span></span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> bar<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token punctuation">{</span> bar<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span></code></section><aside class="comment"><h3 id="-fail-"><code>${fail}</code></h3>
<p> Always fails. Not useful on its own, but can be used for halting/pruning large match result sets.</p>
</aside><div class="content"><code ><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token operator">*</span> <span class="token function">fail</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></div><section class="test" id="test_export function test_fail,fail"><code class="expect">dx<span class="token template-string"><span class="token string">`_ </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fail<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">false</span></code></section><aside class="comment"><h3 id="-value-x-foo-1-primitive-value-"><code>${value(x)}</code>, <code>&quot;foo&quot;</code>, <code>1</code>, <code>${primitive value}</code></h3>
<p> Succeed if the focus <code>===</code> the value.</p>
</aside><div class="content"><code ><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">value</span> <span class="token operator">=</span> <span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">=></span> x <span class="token operator">===</span> val<span class="token punctuation">)</span></code></div><aside class="comment"><p> Double-quoted strings and numbers can be written in the data expression directly.</p>
</aside><section class="test" id="test_export function test_value_literal,value_literal"><code class="expect">dx<span class="token template-string"><span class="token string">`"foo"`</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">true</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`1`</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">true</span></code></section><aside class="comment"><p> Any JS primitives (strings, numbers, bools, symbols) interpolated into the data expression will act as a value pattern.</p>
</aside><section class="test" id="test_export function test_value_interpolation,value_interpolation"><code class="expect">dx<span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">true</span></code><code setup><span class="token keyword">const</span> sym <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'a symbol'</span><span class="token punctuation">)</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>sym<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>sym<span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">true</span></code></section><aside class="comment"><p> Complex data structures cannot be directly interpolated (they&#39;re interpreted as other patterns) but they can be &quot;escaped&quot; with <code>value</code> for testing reference equality.</p>
</aside><section class="test" id="test_export function test_value_escaped,value_escaped"><code setup><span class="token keyword">const</span> <span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">value</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">true</span></code></section><aside class="comment"><h3 id="type-patterns">Type patterns</h3>
<p> Succeeds if the focus has this type.</p>
</aside><div class="content"><code ><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">typeOf</span> <span class="token operator">=</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">typeof</span> x <span class="token operator">===</span> type<span class="token punctuation">)</span> <span class="token comment">// eslint-disable-line valid-typeof</span></code></div><div class="content"><code ><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">instanceOf</span> <span class="token operator">=</span> <span class="token punctuation">(</span>Type<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">=></span> x <span class="token keyword">instanceof</span> <span class="token class-name">Type</span><span class="token punctuation">)</span></code></div><div class="content"><code ><span class="token keyword">export</span> <span class="token keyword">const</span> number <span class="token operator">=</span> <span class="token function">typeOf</span><span class="token punctuation">(</span><span class="token string">'number'</span><span class="token punctuation">)</span></code></div><div class="content"><code ><span class="token keyword">export</span> <span class="token keyword">const</span> string <span class="token operator">=</span> <span class="token function">typeOf</span><span class="token punctuation">(</span><span class="token string">'string'</span><span class="token punctuation">)</span></code></div><div class="content"><code ><span class="token keyword">export</span> <span class="token keyword">const</span> bool <span class="token operator">=</span> <span class="token function">typeOf</span><span class="token punctuation">(</span><span class="token string">'boolean'</span><span class="token punctuation">)</span></code></div><div class="content"><code ><span class="token keyword">export</span> <span class="token keyword">const</span> func <span class="token operator">=</span> <span class="token function">typeOf</span><span class="token punctuation">(</span><span class="token string">'function'</span><span class="token punctuation">)</span></code></div><div class="content"><code ><span class="token keyword">export</span> <span class="token keyword">const</span> symbol <span class="token operator">=</span> <span class="token function">typeOf</span><span class="token punctuation">(</span><span class="token string">'symbol'</span><span class="token punctuation">)</span></code></div><div class="content"><code ><span class="token keyword">export</span> <span class="token keyword">const</span> object <span class="token operator">=</span> <span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">=></span> x <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span></code></div><div class="content"><code ><span class="token keyword">export</span> <span class="token keyword">const</span> array <span class="token operator">=</span> <span class="token function">where</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span>isArray<span class="token punctuation">)</span></code></div><div class="content"><code ><span class="token keyword">export</span> <span class="token keyword">const</span> date <span class="token operator">=</span> <span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">=></span> x <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> x<span class="token punctuation">.</span>getTime <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span></code></div><section class="test" id="test_export function test_type_patterns,type_patterns"><code class="expect">dx<span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>number<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">true</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>string<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">true</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>object<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">123</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">true</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>object<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">false</span></code></section><aside class="comment"><h2 id="lens-patterns">Lens patterns</h2>
<p> These patterns match a <em>subsection</em> of a structure, and <code>replace</code> returns a structure with only that subsection replaced.</p>
<h3 id="-key-foo-foo-foo-foo-"><code>${key(&quot;foo&quot;)}</code>, <code>.foo</code>, <code>.&quot;foo&quot;</code>,<code>.${&quot;foo&quot;}</code></h3>
<p> If the focus has the property <code>foo</code>, yields <code>focus.foo</code>.</p>
</aside><details class="content"><summary ><code ><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">key</span> <span class="token operator">=</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> optional <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">function</span> <span class="token operator">*</span> <span class="token punctuation">(</span>focus<span class="token punctuation">)</span> <span class="token punctuation">{</span></code></summary><code >  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasKey</span><span class="token punctuation">(</span>focus<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">||</span> optional<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><code >    <span class="token keyword">yield</span> <span class="token punctuation">{</span></code><code >      match<span class="token punctuation">:</span> focus<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span></code><code >      replace<span class="token punctuation">:</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>focus<span class="token punctuation">,</span> <span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">:</span> value <span class="token punctuation">}</span><span class="token punctuation">)</span></code><code >    <span class="token punctuation">}</span></code><code >  <span class="token punctuation">}</span></code><code ><span class="token punctuation">}</span></code><code ><span class="token keyword">function</span> <span class="token function">hasKey</span> <span class="token punctuation">(</span>focus<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><code >  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>focus <span class="token operator">||</span> <span class="token keyword">typeof</span> focus <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token boolean">false</span> <span class="token punctuation">}</span></code><code >  <span class="token keyword">return</span> key <span class="token keyword">in</span> focus</code><code ><span class="token punctuation">}</span></code></details><aside class="comment"><p> <code>.match</code> returns the field at <code>key</code> if its present, otherwise it fails.</p>
</aside><section class="test" id="test_export function test_key,key"><code class="expect">dx<span class="token template-string"><span class="token string">`.foo`</span></span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token punctuation">{</span> bar<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token punctuation">{</span> bar<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`.foo`</span></span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token punctuation">{</span> baz<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code><code class="to-equal">undefined</code></section><aside class="comment"><p> <code>.replace</code> returns the object with the value at <code>key</code> updated if it the pattern succeeds, otherwise it returns the original object.</p>
</aside><section class="test" id="test_export function test_key_replace,key_replace"><code class="expect">dx<span class="token template-string"><span class="token string">`.foo`</span></span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token punctuation">{</span> bar<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> quux<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token punctuation">{</span> quux<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`.foo`</span></span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token punctuation">{</span> baz<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> quux<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token punctuation">{</span> baz<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span></code></section><aside class="comment"><h4 id="-key-foo-true-foo-foo-foo-"><code>${key(&quot;foo&quot;, true)}</code>, <code>.foo?</code>, <code>.&quot;foo&quot;?</code>, <code>.${&quot;foo&quot;}?</code></h4>
<p> A key followed by <code>?</code> will always succeed.</p>
</aside><section class="test" id="test_export function test_key_optional,key_optional"><code class="expect">dx<span class="token template-string"><span class="token string">`.baz?`</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token punctuation">{</span> bar<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">true</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`.baz?`</span></span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token punctuation">{</span> bar<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code><code class="to-equal">undefined</code></section><aside class="comment"><p> If the key is not present in the object, <code>.replace</code> will insert the value to the structure.</p>
</aside><section class="test" id="test_export function test_key_optional_replace,key_optional_replace"><code class="expect">dx<span class="token template-string"><span class="token string">`.baz?`</span></span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token punctuation">{</span> bar<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> quux<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token punctuation">{</span> bar<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> baz<span class="token punctuation">:</span> <span class="token punctuation">{</span> quux<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span></code></section><aside class="comment"><h3 id="-index-1-1-1-"><code>${index(1)}</code>, <code>.1</code> , <code>.${1}</code></h3>
<p> Use the value at index <code>1</code> in an array.</p>
</aside><details class="content"><summary ><code ><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">index</span> <span class="token operator">=</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> optional <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">function</span> <span class="token operator">*</span> <span class="token punctuation">(</span>focus<span class="token punctuation">)</span> <span class="token punctuation">{</span></code></summary><code >  <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> i <span class="token operator">=</span> focus<span class="token punctuation">.</span>length <span class="token operator">+</span> i <span class="token punctuation">}</span> <span class="token comment">// allow indexing from end</span></code><code >  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token keyword">in</span> focus<span class="token punctuation">)</span> <span class="token operator">||</span> optional<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><code >    <span class="token keyword">yield</span> <span class="token punctuation">{</span></code><code >      match<span class="token punctuation">:</span> focus<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span></code><code >      replace<span class="token punctuation">:</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></code><code >        <span class="token keyword">const</span> copy <span class="token operator">=</span> focus<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></code><code >        copy<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> value</code><code >        <span class="token keyword">return</span> Array<span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>copy<span class="token punctuation">)</span></code><code >      <span class="token punctuation">}</span></code><code >    <span class="token punctuation">}</span></code><code >  <span class="token punctuation">}</span></code><code ><span class="token punctuation">}</span></code></details><aside class="comment"><p> Match and replace values at the index of the array.</p>
</aside><section class="test" id="test_export function test_index,index"><code class="expect">dx<span class="token template-string"><span class="token string">`.1`</span></span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token string">'baz'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token string">'bar'</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`.1`</span></span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token string">'baz'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'quux'</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'quux'</span><span class="token punctuation">,</span> <span class="token string">'baz'</span><span class="token punctuation">]</span></code></section><aside class="comment"><p> You can also match and replace values from the <em>end</em> of the array, using negative indexes.</p>
</aside><section class="test" id="test_export function test_index_negative,index_negative"><code class="expect">dx<span class="token template-string"><span class="token string">`.-1`</span></span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token string">'baz'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token string">'baz'</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`.-1`</span></span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token string">'baz'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'quux'</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token string">'quux'</span><span class="token punctuation">]</span></code></section><aside class="comment"><p> The pattern fails if the index is beyond the bounds of the array.</p>
</aside><section class="test" id="test_export function test_index_fail,index_fail"><code class="expect">dx<span class="token template-string"><span class="token string">`.5`</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token string">'baz'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">false</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`.5`</span></span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token string">'baz'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'quux'</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token string">'baz'</span><span class="token punctuation">]</span></code></section><aside class="comment"><h4 id="-index-1-true-1-number-"><code>${index(1, true)}</code>,  <code>.1?</code> , <code>.${number}?</code></h4>
<p> As with keys, an index followed by <code>?</code> will always succeed. <code>.test</code> will always return true, and <code>.replace</code> will fill the array with <code>undefined</code> to that index.</p>
</aside><section class="test" id="test_export function test_index_optional,index_optional"><code class="expect">dx<span class="token template-string"><span class="token string">`.5?`</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token string">'baz'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">true</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`.5?`</span></span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token string">'baz'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'quux'</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token string">'baz'</span><span class="token punctuation">,</span> undefined<span class="token punctuation">,</span> undefined<span class="token punctuation">,</span> <span class="token string">'quux'</span><span class="token punctuation">]</span></code></section><aside class="comment"><h3 id="-slice-from-to-1-3-from-to-"><code>${slice(from, to)}</code>, <code>.[1:3]</code>, <code>.[${from}:${to}]</code></h3>
<p> Yields the slice of the array or string.</p>
</aside><details class="content"><summary ><code ><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">slice</span> <span class="token operator">=</span> <span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">function</span> <span class="token operator">*</span> <span class="token punctuation">(</span>focus<span class="token punctuation">)</span> <span class="token punctuation">{</span></code></summary><code >  <span class="token keyword">yield</span> <span class="token punctuation">{</span></code><code >    match<span class="token punctuation">:</span> focus<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">,</span></code><code >    replace<span class="token punctuation">:</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span></code><code >      <span class="token operator">...</span>focus<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> start<span class="token punctuation">)</span><span class="token punctuation">,</span></code><code >      <span class="token operator">...</span>value<span class="token punctuation">,</span></code><code >      <span class="token operator">...</span>focus<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span></code><code >    <span class="token punctuation">]</span></code><code >  <span class="token punctuation">}</span></code><code ><span class="token punctuation">}</span></code></details><aside class="comment"><p> Start and end values are optional, and can index from the end with negative numbers.</p>
</aside><section class="test" id="test_export function test_slice,slice"><code class="expect">dx<span class="token template-string"><span class="token string">`.[1:]`</span></span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token string">'baz'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token punctuation">[</span><span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token string">'baz'</span><span class="token punctuation">]</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`.[:2]`</span></span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token string">'baz'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">]</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`.[-1:]`</span></span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token string">'baz'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token punctuation">[</span><span class="token string">'baz'</span><span class="token punctuation">]</span></code></section><aside class="comment"><p> <code>.replace</code> can insert an arbitrary number of values in place of the slice.</p>
</aside><section class="test" id="test_export function test_slice_replace,slice_replace"><code class="expect">dx<span class="token template-string"><span class="token string">`.[1:3]`</span></span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token string">'baz'</span><span class="token punctuation">,</span> <span class="token string">'quux'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'quux'</span><span class="token punctuation">]</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`.[2:2]`</span></span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token string">'baz'</span><span class="token punctuation">,</span> <span class="token string">'quux'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'baz'</span><span class="token punctuation">,</span> <span class="token string">'quux'</span><span class="token punctuation">]</span></code></section><aside class="comment"><h3 id="-project-getter-setter-"><code>${project(getter, setter)}</code></h3>
<p> Make a custom lens pattern from &quot;getter&quot; and &quot;setter&quot; functions.</p>
<p> If the match should fail, throw from in the getter function.</p>
</aside><details class="content"><summary ><code ><span class="token keyword">export</span> <span class="token keyword">const</span> lens <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">get</span><span class="token punctuation">,</span> <span class="token function-variable function">set</span> <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">=></span> x<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">function</span> <span class="token operator">*</span> <span class="token punctuation">(</span>focus<span class="token punctuation">)</span> <span class="token punctuation">{</span></code></summary><code >  <span class="token keyword">try</span> <span class="token punctuation">{</span></code><code >    <span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span>focus<span class="token punctuation">)</span></code><code >    <span class="token keyword">yield</span> <span class="token punctuation">{</span> match<span class="token punctuation">,</span> replace<span class="token punctuation">:</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">set</span><span class="token punctuation">(</span>focus<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">}</span></code><code >  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code><code ><span class="token punctuation">}</span></code></details><section class="test" id="test_export function test_lens,lens"><code setup><span class="token keyword">const</span> <span class="token function-variable function">mapKey</span> <span class="token operator">=</span> <span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">lens</span><span class="token punctuation">(</span></code><code setup>  <span class="token punctuation">(</span>map<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></code><code setup>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>map<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span></code><code setup>    <span class="token keyword">return</span> map<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span></code><code setup>  <span class="token punctuation">}</span><span class="token punctuation">,</span></code><code setup>  <span class="token punctuation">(</span>map<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></code><code setup>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span></code><code setup>  <span class="token punctuation">}</span></code><code setup><span class="token punctuation">)</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">mapKey</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token number">1</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">mapKey</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">false</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">mapKey</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">mapKey</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></section><aside class="comment"><h2 id="traversal-patterns">Traversal patterns</h2>
<p> These patterns can yield multiple results.</p>
<p> <em>TODO: how should multiple <code>replace</code> work?</em></p>
<h3 id="-regex-foo-foo-"><code>${regex(/^foo+/)}</code>, <code>${/^foo+/}</code></h3>
<p> Regular expressions can be used for matching strings.</p>
</aside><details class="content"><summary ><code ><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">regex</span> <span class="token operator">=</span> <span class="token punctuation">(</span>re<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">function</span> <span class="token operator">*</span> <span class="token punctuation">(</span>focus<span class="token punctuation">)</span> <span class="token punctuation">{</span></code></summary><code >  re <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>re<span class="token punctuation">)</span> <span class="token comment">// "fresh" regex on every invocation</span></code><code >  <span class="token keyword">let</span> match <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>focus<span class="token punctuation">)</span></code><code >  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>match<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span></code><code >  <span class="token keyword">yield</span> <span class="token punctuation">{</span></code><code >    match<span class="token punctuation">:</span> match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span></code><code >    replace<span class="token punctuation">:</span> <span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">=></span> focus<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>re<span class="token punctuation">)</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span></code><code >  <span class="token punctuation">}</span></code><aside class="comment"><p> handle stateful regexes</p>
</aside><code >  <span class="token keyword">if</span> <span class="token punctuation">(</span>re<span class="token punctuation">.</span>global <span class="token operator">||</span> re<span class="token punctuation">.</span>sticky<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><code >    <span class="token keyword">while</span> <span class="token punctuation">(</span>match <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>focus<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// eslint-disable-line no-cond-assign</span></code><code >      <span class="token keyword">let</span> lastIndex <span class="token operator">=</span> match<span class="token punctuation">.</span>lastIndex</code><code >      <span class="token keyword">yield</span> <span class="token punctuation">{</span></code><code >        match<span class="token punctuation">:</span> match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span></code><code >        replace<span class="token punctuation">:</span> <span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></code><aside class="comment"><p> apply the replacement at match position,</p>
<p> but don&#39;t mutate match regex</p>
</aside><code >          <span class="token keyword">const</span> reCopy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>re<span class="token punctuation">)</span></code><code >          reCopy<span class="token punctuation">.</span>lastIndex <span class="token operator">=</span> lastIndex</code><code >          <span class="token keyword">return</span> focus<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>reCopy<span class="token punctuation">,</span> val<span class="token punctuation">)</span></code><code >        <span class="token punctuation">}</span></code><code >      <span class="token punctuation">}</span></code><code >    <span class="token punctuation">}</span></code><code >  <span class="token punctuation">}</span></code><code ><span class="token punctuation">}</span></code></details><section class="test" id="test_export function test_regex,regex"><code class="expect">dx<span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token operator">/</span>f<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">'foobar'</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token string">'foo'</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token operator">/</span>f<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'foobar'</span><span class="token punctuation">,</span> <span class="token string">'baz'</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token string">'bazbar'</span></code></section><aside class="comment"><p> RegEx with the <code>/g</code> and <code>/y</code> flags can yield multiple matches.</p>
</aside><section class="test" id="test_export function test_regex_multiple,regex_multiple"><code setup>expect<span class="token punctuation">.</span><span class="token function">comment</span><span class="token punctuation">(</span><span class="token string">'TODO: reasonable behavior for regex/g.replace'</span><span class="token punctuation">)</span></code><code class="expect"><span class="token punctuation">[</span><span class="token operator">...</span>dx<span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token operator">/</span>h<span class="token punctuation">.</span><span class="token operator">/</span>g<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">.</span><span class="token function">matchAll</span><span class="token punctuation">(</span><span class="token string">'ha ho he hi'</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code><code class="to-equal"><span class="token punctuation">[</span><span class="token string">'ha'</span><span class="token punctuation">,</span> <span class="token string">'ho'</span><span class="token punctuation">,</span> <span class="token string">'he'</span><span class="token punctuation">,</span> <span class="token string">'hi'</span><span class="token punctuation">]</span></code></section><aside class="comment"><h3 id="-spread-"><code>${spread}</code>, <code>*</code></h3>
<p> Yield all values of an array or object.</p>
</aside><details class="content"><summary ><code ><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token operator">*</span> <span class="token function">spread</span> <span class="token punctuation">(</span>focus<span class="token punctuation">)</span> <span class="token punctuation">{</span></code></summary><code >  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">[</span>pattern<span class="token punctuation">]</span> <span class="token keyword">of</span> <span class="token function">lensesForStructure</span><span class="token punctuation">(</span>focus<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><code >    <span class="token keyword">yield</span> <span class="token operator">*</span> <span class="token function">pattern</span><span class="token punctuation">(</span>focus<span class="token punctuation">)</span></code><code >  <span class="token punctuation">}</span></code><code ><span class="token punctuation">}</span></code><code ><span class="token keyword">function</span> <span class="token function">lensesForStructure</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><code >  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><code >    <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">=></span></code><code >      <span class="token punctuation">[</span><span class="token function">index</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> val<span class="token punctuation">]</span><span class="token punctuation">)</span></code><code >  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><code >    <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token operator">=></span></code><code >      <span class="token punctuation">[</span><span class="token function">key</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code><code >  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><code >    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></code><code >  <span class="token punctuation">}</span></code><code ><span class="token punctuation">}</span></code></details><section class="test" id="test_export function test_spread,spread"><code class="expect"><span class="token punctuation">[</span><span class="token operator">...</span>dx<span class="token template-string"><span class="token string">`*`</span></span><span class="token punctuation">.</span><span class="token function">matchAll</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code><code class="to-equal"><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span></code><code class="expect"><span class="token punctuation">[</span><span class="token operator">...</span>dx<span class="token template-string"><span class="token string">`*`</span></span><span class="token punctuation">.</span><span class="token function">matchAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> bar<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> baz<span class="token punctuation">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code><code class="to-equal"><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span></code></section><aside class="comment"><p> Subsequent patterns can filter these results.</p>
</aside><section class="test" id="test_export function test_spread_seq,spread_seq"><code class="expect"><span class="token punctuation">[</span><span class="token operator">...</span>dx<span class="token template-string"><span class="token string">`* </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>number<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">.</span><span class="token function">matchAll</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code><code class="to-equal"><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span></code></section><aside class="comment"><h3 id="-recursive-"><code>${recursive}</code>, <code>**</code></h3>
<p> Yield all values of an array or object recursively.</p>
</aside><details class="content"><summary ><code ><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">recursive</span> <span class="token operator">=</span> <span class="token punctuation">(</span>focus<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">_recursive</span><span class="token punctuation">(</span>focus<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></code></summary><code >recursive<span class="token punctuation">.</span><span class="token function-variable function">maxVisits</span> <span class="token operator">=</span> <span class="token punctuation">(</span>maxVisits<span class="token punctuation">)</span> <span class="token operator">=></span></code><code >  <span class="token punctuation">(</span>focus<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">_recursive</span><span class="token punctuation">(</span>focus<span class="token punctuation">,</span> maxVisits<span class="token punctuation">)</span></code><code ><span class="token keyword">function</span> <span class="token operator">*</span> <span class="token function">_recursive</span> <span class="token punctuation">(</span>focus<span class="token punctuation">,</span> maxVisits<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><code >  <span class="token keyword">const</span> visited <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code><code >  <span class="token keyword">const</span> q <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>id<span class="token punctuation">,</span> focus<span class="token punctuation">]</span><span class="token punctuation">]</span></code><code >  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">[</span>pattern<span class="token punctuation">,</span> node<span class="token punctuation">]</span> <span class="token keyword">of</span> q<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><aside class="comment"><p> prevent infinite recursion</p>
</aside><code >    <span class="token keyword">const</span> visitCount <span class="token operator">=</span> visited<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">0</span></code><code >    <span class="token keyword">if</span> <span class="token punctuation">(</span>visitCount <span class="token operator">>=</span> maxVisits<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">continue</span> <span class="token punctuation">}</span></code><code >    visited<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> visitCount <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span></code><code >    <span class="token keyword">yield</span> <span class="token operator">*</span> <span class="token function">pattern</span><span class="token punctuation">(</span>focus<span class="token punctuation">)</span></code><aside class="comment"><p> yes, you can modify an array while you&#39;re iterating over it</p>
</aside><code >    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">[</span>childpattern<span class="token punctuation">,</span> childNode<span class="token punctuation">]</span> <span class="token keyword">of</span> <span class="token function">lensesForStructure</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><code >      q<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">seq</span><span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> childpattern<span class="token punctuation">)</span><span class="token punctuation">,</span> childNode<span class="token punctuation">]</span><span class="token punctuation">)</span></code><code >    <span class="token punctuation">}</span></code><code >  <span class="token punctuation">}</span></code><code ><span class="token punctuation">}</span></code></details><aside class="comment"><p> <code>.matchAll</code> yields items in breadth-first order, starting with itself.</p>
</aside><section class="test" id="test_export function test_recursive,recursive"><code class="expect"><span class="token punctuation">[</span><span class="token operator">...</span>dx<span class="token template-string"><span class="token string">`**`</span></span><span class="token punctuation">.</span><span class="token function">matchAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> bar<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> baz<span class="token punctuation">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code><code class="to-equal"><span class="token punctuation">[</span>
  <span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> bar<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> baz<span class="token punctuation">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> baz<span class="token punctuation">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> baz<span class="token punctuation">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token number">3</span>
<span class="token punctuation">]</span></code></section><aside class="comment"><p> The recursive pattern combines with other patterns for deep-search effects.</p>
</aside><section class="test" id="test_export function test_recursive_search,recursive_search"><code class="expect">dx<span class="token template-string"><span class="token string">`** .baz`</span></span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> bar<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> baz<span class="token punctuation">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token number">3</span></code></section><aside class="comment"><h2 id="combinators">Combinators</h2>
<p> Combinators are functions that combine patterns into new ones.</p>
<h3 id="-seq-patterns-foo-bar-foo-bar"><code>${seq(patterns...)}</code>,<code>.foo.bar</code> , <code>.foo .bar</code></h3>
<p> Chain sequences of patterns. Whitespace between patterns is optional.</p>
</aside><details class="content"><summary ><code ><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">seq</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">...</span>xs<span class="token punctuation">)</span> <span class="token operator">=></span> xs<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>_seq<span class="token punctuation">,</span> id<span class="token punctuation">)</span></code></summary><code ><span class="token keyword">const</span> <span class="token function-variable function">_seq</span> <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">function</span> <span class="token operator">*</span> <span class="token punctuation">(</span>focus<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><code >  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> outer <span class="token keyword">of</span> <span class="token function">x</span><span class="token punctuation">(</span>focus<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><code >    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> inner <span class="token keyword">of</span> <span class="token function">y</span><span class="token punctuation">(</span>outer<span class="token punctuation">.</span>match<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><code >      <span class="token keyword">yield</span> <span class="token punctuation">{</span></code><code >        match<span class="token punctuation">:</span> inner<span class="token punctuation">.</span>match<span class="token punctuation">,</span></code><code >        replace<span class="token punctuation">:</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=></span> outer<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>inner<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span></code><code >      <span class="token punctuation">}</span></code><code >    <span class="token punctuation">}</span></code><code >  <span class="token punctuation">}</span></code><code ><span class="token punctuation">}</span></code></details><aside class="comment"><p> <code>.match</code> succeeds if each pattern in the sequence succeeds</p>
</aside><section class="test" id="test_export function test_seq,seq"><code setup><span class="token keyword">const</span> fizz <span class="token operator">=</span> <span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">=></span> x <span class="token operator">%</span> <span class="token number">3</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span></code><code setup><span class="token keyword">const</span> buzz <span class="token operator">=</span> <span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">=></span> x <span class="token operator">%</span> <span class="token number">5</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fizz<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>buzz<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">true</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fizz<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>buzz<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">false</span></code></section><aside class="comment"><p> The output of each pattern in the sequence is the input to the following pattern. You can use this with lenses to match and replace deep into structures.</p>
</aside><section class="test" id="test_export function test_seq_pattern,seq_pattern"><code class="expect">dx<span class="token template-string"><span class="token string">`.foo .bar`</span></span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token punctuation">{</span> bar<span class="token punctuation">:</span> <span class="token string">'hello'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token string">'hello'</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`.foo .bar`</span></span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token punctuation">{</span> bar<span class="token punctuation">:</span> <span class="token string">'hello'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'goodbye'</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token punctuation">{</span> bar<span class="token punctuation">:</span> <span class="token string">'goodbye'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span></code></section><aside class="comment"><h3 id="-alt-patterns-foo-bar"><code>${alt(patterns...)}</code>, <code>.foo | .bar</code></h3>
<p> Match multiple patterns on a value.</p>
</aside><details class="content"><summary ><code ><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">alt</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">...</span>xs<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">function</span> <span class="token operator">*</span> <span class="token punctuation">(</span>focus<span class="token punctuation">)</span> <span class="token punctuation">{</span></code></summary><code >  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> x <span class="token keyword">of</span> xs<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><code >    <span class="token keyword">yield</span> <span class="token operator">*</span> <span class="token function">x</span><span class="token punctuation">(</span>focus<span class="token punctuation">)</span></code><code >  <span class="token punctuation">}</span></code><code ><span class="token punctuation">}</span></code></details><section class="test" id="test_export function test_alt,alt"><code setup><span class="token keyword">const</span> fizz <span class="token operator">=</span> <span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">=></span> x <span class="token operator">%</span> <span class="token number">3</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span></code><code setup><span class="token keyword">const</span> buzz <span class="token operator">=</span> <span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">=></span> x <span class="token operator">%</span> <span class="token number">5</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fizz<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> | </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>buzz<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">true</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fizz<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> | </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>buzz<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">true</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fizz<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> | </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>buzz<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">true</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fizz<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> | </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>buzz<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">false</span></code></section><aside class="comment"><p> Note that <code>.matchAll</code> returns an iterator, and will return <em>both</em> results if they both succeed.</p>
</aside><section class="test" id="test_export function test_alt_match,alt_match"><code class="expect">dx<span class="token template-string"><span class="token string">`.foo | .bar`</span></span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> baz<span class="token punctuation">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token number">1</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`.foo | .bar`</span></span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token punctuation">{</span> bar<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> quux<span class="token punctuation">:</span> <span class="token number">4</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token number">2</span></code><code class="expect"><span class="token punctuation">[</span><span class="token operator">...</span>dx<span class="token template-string"><span class="token string">`.foo | .bar`</span></span><span class="token punctuation">.</span><span class="token function">matchAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> bar<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code><code class="to-equal"><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span></code></section><aside class="comment"><p> Parentheses can be used to group <code>|</code> in sequences.</p>
</aside><section class="test" id="test_export function test_alt_operator_precedence,alt_operator_precedence"><code class="expect">dx<span class="token template-string"><span class="token string">`.foo .bar | .baz`</span></span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> bar<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> baz<span class="token punctuation">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token number">3</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`.foo (.bar | .baz)`</span></span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token punctuation">{</span> bar<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> baz<span class="token punctuation">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token number">2</span></code></section><aside class="comment"><p> TODO: multiple replacement</p>
<h3 id="-and-pattern-pattern-"><code>${and(pattern)}</code>, <code>${pattern} &amp;</code></h3>
<p> If the pattern succeeds, yield the focus instead of the result.</p>
</aside><details class="content"><summary ><code ><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">and</span> <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">function</span> <span class="token operator">*</span> <span class="token punctuation">(</span>focus<span class="token punctuation">)</span> <span class="token punctuation">{</span></code></summary><code >  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> _ <span class="token keyword">of</span> <span class="token function">x</span><span class="token punctuation">(</span>focus<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><code >    <span class="token keyword">yield</span> <span class="token operator">*</span> <span class="token function">id</span><span class="token punctuation">(</span>focus<span class="token punctuation">)</span></code><code >    <span class="token keyword">return</span></code><code >  <span class="token punctuation">}</span></code><code ><span class="token punctuation">}</span></code></details><section class="test" id="test_export function test_and,and"><code class="expect">dx<span class="token template-string"><span class="token string">`.foo &amp;`</span></span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> bar<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> bar<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`.foo &amp; .bar`</span></span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> bar<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token number">2</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`.foo &amp; .bar`</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">{</span> bar<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">false</span></code></section><aside class="comment"><h3 id="-limit-pattern-maxcount-1-pattern-"><code>${limit(pattern, maxCount=1)}</code>, <code>${pattern} !</code></h3>
</aside><details class="content"><summary ><code ><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">limit</span> <span class="token operator">=</span> <span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> maxCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">function</span> <span class="token operator">*</span> <span class="token punctuation">(</span>focus<span class="token punctuation">)</span> <span class="token punctuation">{</span></code></summary><code >  <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span></code><code >  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> item <span class="token keyword">of</span> <span class="token function">pattern</span><span class="token punctuation">(</span>focus<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><code >    <span class="token keyword">if</span> <span class="token punctuation">(</span>maxCount <span class="token operator">&lt;=</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span></code><code >    <span class="token keyword">yield</span> item</code><code >    count<span class="token operator">++</span></code><code >  <span class="token punctuation">}</span></code><code ><span class="token punctuation">}</span></code></details><aside class="comment"><p> Limit the number of results a pattern can return. The operator form limits to 1 match.</p>
</aside><section class="test" id="test_export function test_limit,limit"><code class="expect"><span class="token punctuation">[</span><span class="token operator">...</span>dx<span class="token template-string"><span class="token string">`(.foo | .bar)! .baz`</span></span><span class="token punctuation">.</span><span class="token function">matchAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token punctuation">{</span> baz<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> bar<span class="token punctuation">:</span> <span class="token punctuation">{</span> baz<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code><code class="to-equal"><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span></code></section><aside class="comment"><p> This can &quot;commit&quot; a match to a particular branch once it succeeds:</p>
</aside><section class="test" id="test_export function test_limit_commit,limit_commit"><code class="expect">dx<span class="token template-string"><span class="token string">`(.foo | .bar) .baz`</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> bar<span class="token punctuation">:</span> <span class="token punctuation">{</span> baz<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">true</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`(.foo | .bar)! .baz`</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> bar<span class="token punctuation">:</span> <span class="token punctuation">{</span> baz<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">false</span></code></section><aside class="comment"><h3 id="-collect-pattern-"><code>${collect(pattern)}</code></h3>
<p> Combine multiple match results into a single array.</p>
</aside><details class="content"><summary ><code ><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">collect</span> <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> reducer <span class="token operator">=</span> defaultReducer<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">function</span> <span class="token operator">*</span> <span class="token punctuation">(</span>focus<span class="token punctuation">)</span> <span class="token punctuation">{</span></code></summary><code >  <span class="token keyword">let</span> collected</code><code >  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> pattern <span class="token keyword">of</span> <span class="token function">x</span><span class="token punctuation">(</span>focus<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><code >    collected <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span>collected<span class="token punctuation">,</span> pattern<span class="token punctuation">)</span></code><code >  <span class="token punctuation">}</span></code><code >  <span class="token keyword">yield</span> collected</code><code ><span class="token punctuation">}</span></code><code ><span class="token keyword">function</span> <span class="token function">defaultReducer</span> <span class="token punctuation">(</span>l <span class="token operator">=</span> <span class="token punctuation">{</span> match<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> replace<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><code >  <span class="token keyword">return</span> <span class="token punctuation">{</span></code><code >    match<span class="token punctuation">:</span> l<span class="token punctuation">.</span>match<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>r<span class="token punctuation">.</span>match<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code><code >    replace<span class="token punctuation">:</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=></span> l<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>r<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code><code >  <span class="token punctuation">}</span></code><code ><span class="token punctuation">}</span></code></details><section class="test" id="test_export function test_collect,collect"><code class="expect">dx<span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">collect</span><span class="token punctuation">(</span>dx<span class="token template-string"><span class="token string">`.foo | .bar`</span></span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> bar<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> baz<span class="token punctuation">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span></code></section><aside class="comment"><h2 id="structure-patterns">Structure patterns</h2>
<p> These patterns match the shapes of structures.</p>
<h3 id="-foo-x-bar-y-z-"><code>{foo: ${x}, bar?: ${y}, ...${z} }</code></h3>
<p> Succeeds if focus is an object where <em>all</em> fields match the patterns at the corresponding key. Keys can also be <em>optional</em> -- if the key is present in the focus, it must match; otherwise it is skipped. Replacement propagates <em>through</em> the object&#39;s fields.</p>
</aside><details class="content"><summary ><code ><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">objectShape</span> <span class="token operator">=</span> <span class="token punctuation">(</span>entries<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></code></summary><code >  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>entries<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=></span> e<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'RestEntry'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><code >    entries <span class="token operator">=</span> entries<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>objectInit<span class="token punctuation">]</span><span class="token punctuation">)</span></code><code >  <span class="token punctuation">}</span></code><code >  <span class="token keyword">return</span> entries<span class="token punctuation">.</span><span class="token function">reduceRight</span><span class="token punctuation">(</span>entryReducer<span class="token punctuation">)</span></code><code ><span class="token punctuation">}</span></code><code ><span class="token keyword">const</span> <span class="token function-variable function">entryReducer</span> <span class="token operator">=</span> <span class="token punctuation">(</span>acc<span class="token punctuation">,</span> entry<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">function</span> <span class="token operator">*</span> <span class="token punctuation">(</span>focus<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><code >  <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'RestEntry'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><code >    <span class="token keyword">yield</span> <span class="token operator">*</span> entry<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span>focus<span class="token punctuation">)</span></code><code >    <span class="token keyword">return</span></code><code >  <span class="token punctuation">}</span></code><code >  <span class="token keyword">const</span> <span class="token punctuation">{</span> key<span class="token punctuation">,</span> value<span class="token punctuation">:</span> pattern<span class="token punctuation">,</span> optional <span class="token punctuation">}</span> <span class="token operator">=</span> entry</code><code >  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasKey</span><span class="token punctuation">(</span>focus<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><code >    <span class="token keyword">if</span> <span class="token punctuation">(</span>optional<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">yield</span> <span class="token operator">*</span> <span class="token function">acc</span><span class="token punctuation">(</span>focus<span class="token punctuation">)</span> <span class="token punctuation">}</span></code><code >    <span class="token keyword">return</span></code><code >  <span class="token punctuation">}</span></code><code >  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">:</span> keyFocus<span class="token punctuation">,</span> <span class="token operator">...</span>restFocus <span class="token punctuation">}</span> <span class="token operator">=</span> focus</code><code >  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> outer <span class="token keyword">of</span> <span class="token function">acc</span><span class="token punctuation">(</span>restFocus<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><code >    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> inner <span class="token keyword">of</span> <span class="token function">pattern</span><span class="token punctuation">(</span>keyFocus<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><code >      <span class="token keyword">yield</span> <span class="token punctuation">{</span></code><code >        match<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span>outer<span class="token punctuation">.</span>match<span class="token punctuation">,</span> <span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">:</span> inner<span class="token punctuation">.</span>match <span class="token punctuation">}</span><span class="token punctuation">,</span></code><code >        replace<span class="token punctuation">:</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span></code><code >          <span class="token operator">...</span>outer<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span></code><code >          <span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">:</span> inner<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>value<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span></code><code >        <span class="token punctuation">}</span><span class="token punctuation">)</span></code><code >      <span class="token punctuation">}</span></code><code >    <span class="token punctuation">}</span></code><code >  <span class="token punctuation">}</span></code><code ><span class="token punctuation">}</span></code><code ><span class="token keyword">const</span> <span class="token function-variable function">objectInit</span> <span class="token operator">=</span> <span class="token punctuation">(</span>focus<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token punctuation">{</span> match<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> replace<span class="token punctuation">:</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>focus<span class="token punctuation">,</span> <span class="token operator">...</span>value <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">]</span></code></details><aside class="comment"><p> The pattern succeeds if all fields succeed.</p>
</aside><section class="test" id="test_export function test_objectShape,objectShape"><code class="expect">dx<span class="token template-string"><span class="token string">`{foo: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>number<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, bar: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>string<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">}`</span></span>
  <span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> bar<span class="token punctuation">:</span> <span class="token string">'a string'</span><span class="token punctuation">,</span> baz<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'else'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">true</span></code></section><aside class="comment"><p> Match returns only the matched fields.</p>
</aside><section class="test" id="test_export function test_objectShape_match,objectShape_match"><code class="expect">dx<span class="token template-string"><span class="token string">`{foo: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>number<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, bar: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>string<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">}`</span></span>
  <span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> bar<span class="token punctuation">:</span> <span class="token string">'a string'</span><span class="token punctuation">,</span> baz<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'else'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> bar<span class="token punctuation">:</span> <span class="token string">'a string'</span> <span class="token punctuation">}</span></code></section><aside class="comment"><p> Replace merges the replacement values onto the object.</p>
</aside><section class="test" id="test_export function test_objectShape_merge,objectShape_merge"><code class="expect">dx<span class="token template-string"><span class="token string">`{foo: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>number<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, bar: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>string<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">}`</span></span>
  <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> bar<span class="token punctuation">:</span> <span class="token string">'a string'</span><span class="token punctuation">,</span> baz<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'else'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span> bar<span class="token punctuation">:</span> <span class="token string">'flerb'</span><span class="token punctuation">,</span> quux<span class="token punctuation">:</span> <span class="token number">100</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span> bar<span class="token punctuation">:</span> <span class="token string">'flerb'</span><span class="token punctuation">,</span> baz<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'else'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> quux<span class="token punctuation">:</span> <span class="token number">100</span> <span class="token punctuation">}</span></code></section><aside class="comment"><p> The pattern fails if a field is missing from the focus, or its pattern fails.</p>
</aside><section class="test" id="test_export function test_objectShape_fail,objectShape_fail"><code class="expect">dx<span class="token template-string"><span class="token string">`{foo: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>number<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, bar: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>string<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">}`</span></span>
  <span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">20</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">false</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`{foo: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>number<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, bar: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>string<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">}`</span></span>
  <span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token string">'not a number'</span><span class="token punctuation">,</span> bar<span class="token punctuation">:</span> <span class="token string">'a string'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">false</span></code></section><aside class="comment"><p> <code>id</code> or <code>_</code> can test for the presence of a field, regardless of the value.</p>
</aside><section class="test" id="test_export function test_objectShape_placeholder,objectShape_placeholder"><code class="expect">dx<span class="token template-string"><span class="token string">`{type: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>string<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, payload: _}`</span></span>
  <span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'foo'</span><span class="token punctuation">,</span> payload<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">true</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`{type: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>string<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, payload: _}`</span></span>
  <span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'bar'</span><span class="token punctuation">,</span> payload<span class="token punctuation">:</span> <span class="token number">42</span><span class="token punctuation">,</span> error<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">true</span></code></section><aside class="comment"><p> Patterns can have optional fields, marked with <code>?</code>.</p>
</aside><section class="test" id="test_export function test_objectShape_optional,objectShape_optional"><code class="expect">dx<span class="token template-string"><span class="token string">`{foo: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>number<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, bar?: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>string<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">}`</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">123</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">true</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`{foo: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>number<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, bar?: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>string<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">}`</span></span>
  <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">123</span><span class="token punctuation">,</span> baz<span class="token punctuation">:</span> <span class="token number">789</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">456</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">456</span><span class="token punctuation">,</span> baz<span class="token punctuation">:</span> <span class="token number">789</span> <span class="token punctuation">}</span></code></section><aside class="comment"><p> The pattern will still fail if the field is present on the focus but its pattern doesn&#39;t match.</p>
</aside><section class="test" id="test_export function test_objectShape_optional_fail,objectShape_optional_fail"><code class="expect">dx<span class="token template-string"><span class="token string">`{foo: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>number<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, bar?: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>string<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">}`</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">123</span><span class="token punctuation">,</span> bar<span class="token punctuation">:</span> <span class="token number">456</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">false</span></code></section><section class="test" id="test_export function test_objectShape_additional,objectShape_additional"><code setup>expect<span class="token punctuation">.</span><span class="token function">comment</span><span class="token punctuation">(</span><span class="token string">'TODO: rest patterns, pattern/traversal propagation, multiple rests, `...{exact}` '</span><span class="token punctuation">)</span></code></section><aside class="comment"><h3 id="-x-y-rest-"><code>[${x}, ${y}, ...${rest}]</code></h3>
<p> Succeeds if every pattern matches the value at that index or for the rest of the array.</p>
</aside><details class="content"><summary ><code ><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">arrayShape</span> <span class="token operator">=</span> <span class="token punctuation">(</span>entries<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">function</span> <span class="token operator">*</span> <span class="token punctuation">(</span>focus<span class="token punctuation">)</span> <span class="token punctuation">{</span></code></summary><code >  <span class="token keyword">const</span> <span class="token punctuation">[</span>entry<span class="token punctuation">,</span> <span class="token operator">...</span>restEntries<span class="token punctuation">]</span> <span class="token operator">=</span> entries</code><code >  <span class="token keyword">const</span> <span class="token punctuation">[</span>headFocus<span class="token punctuation">,</span> <span class="token operator">...</span>restFocus<span class="token punctuation">]</span> <span class="token operator">=</span> focus</code><aside class="comment"><p> base case</p>
</aside><code >  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>focus<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span></code><code >    <span class="token punctuation">(</span><span class="token operator">!</span>entries<span class="token punctuation">.</span>length <span class="token operator">||</span> entry <span class="token operator">&amp;&amp;</span> entry<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'RestEntry'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><code >    <span class="token keyword">yield</span> <span class="token punctuation">{</span> match<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> replace<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span></code><code >    <span class="token keyword">return</span></code><code >  <span class="token punctuation">}</span></code><aside class="comment"><p> fail: out of either focus or entries</p>
</aside><code >  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>focus<span class="token punctuation">.</span>length <span class="token operator">||</span> <span class="token operator">!</span>entries<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><code >    <span class="token keyword">return</span></code><code >  <span class="token punctuation">}</span></code><code >  <span class="token keyword">const</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> value<span class="token punctuation">:</span> pattern <span class="token punctuation">}</span> <span class="token operator">=</span> entry</code><code >  <span class="token keyword">const</span> nextPattern <span class="token operator">=</span> type <span class="token operator">===</span> <span class="token string">'RestEntry'</span></code><code >    <span class="token operator">?</span> <span class="token function">arrayShape</span><span class="token punctuation">(</span>entries<span class="token punctuation">)</span></code><code >    <span class="token punctuation">:</span> <span class="token function">arrayShape</span><span class="token punctuation">(</span>restEntries<span class="token punctuation">)</span></code><code >  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> h <span class="token keyword">of</span> <span class="token function">pattern</span><span class="token punctuation">(</span>headFocus<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><code >    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> r <span class="token keyword">of</span> <span class="token function">nextPattern</span><span class="token punctuation">(</span>restFocus<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code><code >      <span class="token keyword">yield</span> <span class="token punctuation">{</span></code><code >        match<span class="token punctuation">:</span> <span class="token punctuation">[</span>h<span class="token punctuation">.</span>match<span class="token punctuation">,</span> <span class="token operator">...</span>r<span class="token punctuation">.</span>match<span class="token punctuation">]</span><span class="token punctuation">,</span></code><code >        replace<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>value<span class="token punctuation">,</span> <span class="token operator">...</span>restValue<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span></code><code >          h<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span></code><code >          <span class="token operator">...</span>r<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>restValue<span class="token punctuation">)</span></code><code >        <span class="token punctuation">]</span></code><code >      <span class="token punctuation">}</span></code><code >    <span class="token punctuation">}</span></code><code >  <span class="token punctuation">}</span></code><code ><span class="token punctuation">}</span></code></details><aside class="comment"><p> The pattern must match every item in the focus array; missing or additional items cause the pattern to fail.</p>
</aside><section class="test" id="test_export function test_array,array"><code class="expect">dx<span class="token template-string"><span class="token string">`["foo", </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>number<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]`</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">true</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`["foo", </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>number<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]`</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">false</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`["foo", </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>number<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]`</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">false</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`["foo", </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>number<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]`</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">false</span></code></section><aside class="comment"><p> You can &quot;spread&quot; a pattern to match the remaining items in an array.</p>
</aside><section class="test" id="test_export function test_array_rest,array_rest"><code class="expect">dx<span class="token template-string"><span class="token string">`["foo", ...</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>number<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]`</span></span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`["foo", ... .x]`</span></span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span></code></section><aside class="comment"><p> If you only want to match against the first few items in an array, you can spread the identity pattern:</p>
</aside><section class="test" id="test_export function test_array_id,array_id"><code class="expect">dx<span class="token template-string"><span class="token string">`["foo", ..._]`</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">true</span></code><code class="expect">dx<span class="token template-string"><span class="token string">`["foo", ..._]`</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">true</span></code></section><aside class="comment"><p> If you match against <em>only</em> a spread, you can test if all the items in an array match a pattern.</p>
</aside><section class="test" id="test_export function test_array_of,array_of"><code class="expect">dx<span class="token template-string"><span class="token string">`[...</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>number<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]`</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code><code class="to-equal"><span class="token boolean">true</span></code></section></body></html>