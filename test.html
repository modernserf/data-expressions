<!doctype html><html ><head ><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1"><title >test.js | DatEx</title><link rel="stylesheet" type="text/css" href="doc.css" /></head><body ><aside class="comment"><h1 id="test-framework">Test framework</h1>
<p> This library has its code, documentation, and tests intertwingled; the tests act as examples for the code. This is made possible with Rollup&#39;s &quot;tree-shaking&quot; -- the tests aren&#39;t included in the bundled output.</p>
</aside><details class="content"><summary ><code ><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> patterns <span class="token keyword">from</span> <span class="token string">'./patterns.js'</span></code></summary><code ><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> parser <span class="token keyword">from</span> <span class="token string">'./parser.js'</span></code><code ><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> operations <span class="token keyword">from</span> <span class="token string">'./operations.js'</span></code><code ><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> index <span class="token keyword">from</span> <span class="token string">'./index.js'</span></code><code ><span class="token keyword">const</span> tape <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tape'</span><span class="token punctuation">)</span></code></details><aside class="comment"><p> Use Jasmine-style <code>expect(value).toEqual(expected)</code> test assertions.</p>
</aside><details class="content"><summary ><code ><span class="token keyword">function</span> <span class="token function">expecter</span> <span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token punctuation">{</span></code></summary><code >  <span class="token keyword">const</span> <span class="token function-variable function">f</span> <span class="token operator">=</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span></code><code >    toEqual<span class="token punctuation">:</span> <span class="token punctuation">(</span>expected<span class="token punctuation">)</span> <span class="token operator">=></span> t<span class="token punctuation">.</span><span class="token function">deepEquals</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> expected<span class="token punctuation">)</span><span class="token punctuation">,</span></code><code >    toThrow<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> t<span class="token punctuation">.</span><span class="token function">throws</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span></code><code >  <span class="token punctuation">}</span><span class="token punctuation">)</span></code><code >  f<span class="token punctuation">.</span><span class="token function-variable function">comment</span> <span class="token operator">=</span> <span class="token punctuation">(</span>comment<span class="token punctuation">)</span> <span class="token operator">=></span> t<span class="token punctuation">.</span><span class="token function">comment</span><span class="token punctuation">(</span>comment<span class="token punctuation">)</span></code><code >  <span class="token keyword">return</span> f</code><code ><span class="token punctuation">}</span></code></details><aside class="comment"><p> Use the exported function&#39;s name to determine if it&#39;s a test, and if it should be skipped/isolated.</p>
</aside><details class="content"><summary ><code ><span class="token keyword">function</span> <span class="token function">tester</span> <span class="token punctuation">(</span>tape<span class="token punctuation">,</span> key<span class="token punctuation">,</span> cb<span class="token punctuation">)</span> <span class="token punctuation">{</span></code></summary><code >  <span class="token keyword">const</span> test <span class="token operator">=</span> <span class="token regex">/^only_test_/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">?</span> tape<span class="token punctuation">.</span>only</code><code >    <span class="token punctuation">:</span> <span class="token regex">/^skip_test_/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">?</span> tape<span class="token punctuation">.</span>skip</code><code >      <span class="token punctuation">:</span> <span class="token regex">/^test_/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">?</span> tape</code><code >        <span class="token punctuation">:</span> <span class="token keyword">null</span></code><code >  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>test<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span></code><aside class="comment"><p> Extract a properly-formatted name from the test function name.</p>
</aside><code >  <span class="token keyword">const</span> message <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/^(skip_|only_)?test_/</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/_/g</span><span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">)</span></code><code >  <span class="token keyword">return</span> <span class="token function">test</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> <span class="token punctuation">{</span> objectPrintDepth<span class="token punctuation">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code><code ><span class="token punctuation">}</span></code></details><aside class="comment"><p> If any of the exported values are test functions, run them with <code>tape</code>.</p>
</aside><details class="content"><summary ><code ><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> dep <span class="token keyword">of</span> <span class="token punctuation">[</span>patterns<span class="token punctuation">,</span> parser<span class="token punctuation">,</span> operations<span class="token punctuation">,</span> index<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></code></summary><code >  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> dep<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><code >    <span class="token function">tester</span><span class="token punctuation">(</span>tape<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></code><aside class="comment"><p> Call the test with <code>expect</code> and <code>dx</code> as arguments.</p>
</aside><code >      <span class="token keyword">const</span> out <span class="token operator">=</span> dep<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token function">expecter</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">,</span> parser<span class="token punctuation">.</span>dx<span class="token punctuation">)</span></code><aside class="comment"><p> Return values are ignored, but async functions always return a promise, so assume a return value implies an async test.</p>
</aside><code >      <span class="token keyword">if</span> <span class="token punctuation">(</span>out<span class="token punctuation">)</span> <span class="token punctuation">{</span></code><code >        Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> t<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code><code >      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></code><code >        t<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code><code >      <span class="token punctuation">}</span></code><code >    <span class="token punctuation">}</span><span class="token punctuation">)</span></code><code >  <span class="token punctuation">}</span></code><code ><span class="token punctuation">}</span></code></details></body></html>